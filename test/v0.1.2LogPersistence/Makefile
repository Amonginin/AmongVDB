# Makefile for Persistence Testing v0.1.2
# æ•°æ®æ—¥å¿—æŒä¹…åŒ–åŠŸèƒ½æµ‹è¯•æ„å»ºæ–‡ä»¶

# ç¼–è¯‘å™¨è®¾ç½®
CXX = g++
CXXFLAGS = -std=c++17 -Wall -Wextra -O2 -g
INCLUDES = -I../../include -I../..
LIBS = -lrocksdb -lfaiss -lpthread -lspdlog -lstdc++fs

# ç›®å½•è®¾ç½®
SRC_DIR = ../..
COMMON_DIR = common
UNIT_DIR = unit
INTEGRATION_DIR = integration
PERFORMANCE_DIR = performance
ERRORS_DIR = errors

# æºæ–‡ä»¶
COMMON_SRCS = $(COMMON_DIR)/test_utils.cpp
MAIN_SRCS = $(SRC_DIR)/persistence.cpp \
           $(SRC_DIR)/vector_database.cpp \
           $(SRC_DIR)/scalar_storage.cpp \
           $(SRC_DIR)/index_factory.cpp \
           $(SRC_DIR)/faiss_index.cpp \
           $(SRC_DIR)/hnswlib_index.cpp \
           $(SRC_DIR)/filter_index.cpp \
           $(SRC_DIR)/logger.cpp

# ç›®æ ‡æ–‡ä»¶
UNIT_TARGET = unit_tests
INTEGRATION_TARGET = integration_tests
PERFORMANCE_TARGET = performance_tests
ERRORS_TARGET = error_tests

# é»˜è®¤ç›®æ ‡
.PHONY: all clean unit integration performance errors help setup

all: setup unit integration performance errors

# è®¾ç½®æµ‹è¯•ç¯å¢ƒ
setup:
	@echo "ğŸ”§ è®¾ç½®æµ‹è¯•ç¯å¢ƒ..."
	@mkdir -p /tmp/vdb_test_v0.1.2
	@echo "âœ… æµ‹è¯•ç¯å¢ƒè®¾ç½®å®Œæˆ"

# å•å…ƒæµ‹è¯•
unit: $(UNIT_TARGET)

$(UNIT_TARGET): $(UNIT_DIR)/test_persistence_unit.cpp $(COMMON_SRCS) $(MAIN_SRCS)
	@echo "ğŸ”¨ ç¼–è¯‘å•å…ƒæµ‹è¯•..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) -o $@ $^ $(LIBS)
	@echo "âœ… å•å…ƒæµ‹è¯•ç¼–è¯‘å®Œæˆ: $(UNIT_TARGET)"

# é›†æˆæµ‹è¯•
integration: $(INTEGRATION_TARGET)

$(INTEGRATION_TARGET): $(INTEGRATION_DIR)/test_persistence_integration.cpp $(COMMON_SRCS) $(MAIN_SRCS)
	@echo "ğŸ”¨ ç¼–è¯‘é›†æˆæµ‹è¯•..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) -o $@ $^ $(LIBS)
	@echo "âœ… é›†æˆæµ‹è¯•ç¼–è¯‘å®Œæˆ: $(INTEGRATION_TARGET)"

# æ€§èƒ½æµ‹è¯•
performance: $(PERFORMANCE_TARGET)

$(PERFORMANCE_TARGET): $(PERFORMANCE_DIR)/test_persistence_performance.cpp $(COMMON_SRCS) $(MAIN_SRCS)
	@echo "ğŸ”¨ ç¼–è¯‘æ€§èƒ½æµ‹è¯•..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) -o $@ $^ $(LIBS)
	@echo "âœ… æ€§èƒ½æµ‹è¯•ç¼–è¯‘å®Œæˆ: $(PERFORMANCE_TARGET)"

# é”™è¯¯æµ‹è¯•
errors: $(ERRORS_TARGET)

$(ERRORS_TARGET): $(ERRORS_DIR)/test_persistence_errors.cpp $(COMMON_SRCS) $(MAIN_SRCS)
	@echo "ğŸ”¨ ç¼–è¯‘é”™è¯¯æµ‹è¯•..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) -o $@ $^ $(LIBS)
	@echo "âœ… é”™è¯¯æµ‹è¯•ç¼–è¯‘å®Œæˆ: $(ERRORS_TARGET)"

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
run-all: all
	@echo "ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•..."
	@echo "\nğŸ“‹ 1. å•å…ƒæµ‹è¯•"
	@./$(UNIT_TARGET) || echo "âŒ å•å…ƒæµ‹è¯•å¤±è´¥"
	@echo "\nğŸ“‹ 2. é›†æˆæµ‹è¯•"
	@./$(INTEGRATION_TARGET) || echo "âŒ é›†æˆæµ‹è¯•å¤±è´¥"
	@echo "\nğŸ“‹ 3. æ€§èƒ½æµ‹è¯•"
	@./$(PERFORMANCE_TARGET) || echo "âŒ æ€§èƒ½æµ‹è¯•å¤±è´¥"
	@echo "\nğŸ“‹ 4. é”™è¯¯æµ‹è¯•"
	@./$(ERRORS_TARGET) || echo "âŒ é”™è¯¯æµ‹è¯•å¤±è´¥"
	@echo "\nğŸ‰ æ‰€æœ‰æµ‹è¯•è¿è¡Œå®Œæˆï¼"

# è¿è¡Œå•ç‹¬æµ‹è¯•
run-unit: $(UNIT_TARGET)
	@echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
	@./$(UNIT_TARGET)

run-integration: $(INTEGRATION_TARGET)
	@echo "ğŸ§ª è¿è¡Œé›†æˆæµ‹è¯•..."
	@./$(INTEGRATION_TARGET)

run-performance: $(PERFORMANCE_TARGET)
	@echo "ğŸ§ª è¿è¡Œæ€§èƒ½æµ‹è¯•..."
	@./$(PERFORMANCE_TARGET)

run-errors: $(ERRORS_TARGET)
	@echo "ğŸ§ª è¿è¡Œé”™è¯¯æµ‹è¯•..."
	@./$(ERRORS_TARGET)

# è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•
run-e2e:
	@echo "ğŸ§ª è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•..."
	@chmod +x e2e/test_persistence_e2e.sh
	@cd e2e && ./test_persistence_e2e.sh

# æ¸…ç†
clean:
	@echo "ğŸ§¹ æ¸…ç†æ„å»ºæ–‡ä»¶..."
	@rm -f $(UNIT_TARGET) $(INTEGRATION_TARGET) $(PERFORMANCE_TARGET) $(ERRORS_TARGET)
	@rm -rf /tmp/vdb_test_v0.1.2
	@echo "âœ… æ¸…ç†å®Œæˆ"

# å®‰è£…ä¾èµ–
install-deps:
	@echo "ğŸ“¦ æ£€æŸ¥ä¾èµ–..."
	@echo "è¯·ç¡®ä¿å·²å®‰è£…ä»¥ä¸‹ä¾èµ–:"
	@echo "  - RocksDB"
	@echo "  - Faiss"
	@echo "  - spdlog"
	@echo "  - rapidjson"
	@echo ""
	@echo "Ubuntu/Debian å®‰è£…å‘½ä»¤:"
	@echo "  sudo apt-get install librocksdb-dev libfaiss-dev libspdlog-dev rapidjson-dev"
	@echo ""
	@echo "CentOS/RHEL å®‰è£…å‘½ä»¤:"
	@echo "  sudo yum install rocksdb-devel faiss-devel spdlog-devel rapidjson-devel"

# ä»£ç æ ¼å¼åŒ–
format:
	@echo "ğŸ¨ æ ¼å¼åŒ–ä»£ç ..."
	@find . -name "*.cpp" -o -name "*.h" | xargs clang-format -i
	@echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ"

# é™æ€åˆ†æ
analyze:
	@echo "ğŸ” è¿è¡Œé™æ€åˆ†æ..."
	@cppcheck --enable=all --std=c++17 --suppress=missingIncludeSystem \
		$(UNIT_DIR)/ $(INTEGRATION_DIR)/ $(PERFORMANCE_DIR)/ $(ERRORS_DIR)/ $(COMMON_DIR)/
	@echo "âœ… é™æ€åˆ†æå®Œæˆ"

# å†…å­˜æ£€æŸ¥
memcheck: $(UNIT_TARGET)
	@echo "ğŸ” è¿è¡Œå†…å­˜æ£€æŸ¥..."
	@valgrind --tool=memcheck --leak-check=full --show-leak-kinds=all \
		--track-origins=yes ./$(UNIT_TARGET)

# æ€§èƒ½åˆ†æ
profile: $(PERFORMANCE_TARGET)
	@echo "ğŸ“Š è¿è¡Œæ€§èƒ½åˆ†æ..."
	@perf record -g ./$(PERFORMANCE_TARGET)
	@perf report

# è¦†ç›–ç‡æµ‹è¯•
coverage:
	@echo "ğŸ“ˆ ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š..."
	@$(MAKE) CXXFLAGS="$(CXXFLAGS) --coverage" all
	@./$(UNIT_TARGET)
	@./$(INTEGRATION_TARGET)
	@gcov *.gcno
	@lcov --capture --directory . --output-file coverage.info
	@genhtml coverage.info --output-directory coverage_html
	@echo "âœ… è¦†ç›–ç‡æŠ¥å‘Šç”Ÿæˆå®Œæˆï¼ŒæŸ¥çœ‹: coverage_html/index.html"

# è°ƒè¯•æ„å»º
debug:
	@echo "ğŸ› æ„å»ºè°ƒè¯•ç‰ˆæœ¬..."
	@$(MAKE) CXXFLAGS="$(CXXFLAGS) -DDEBUG -O0" all

# å‘å¸ƒæ„å»º
release:
	@echo "ğŸš€ æ„å»ºå‘å¸ƒç‰ˆæœ¬..."
	@$(MAKE) CXXFLAGS="$(CXXFLAGS) -DNDEBUG -O3" all

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "ğŸ†˜ Persistence Testing v0.1.2 æ„å»ºå¸®åŠ©"
	@echo "==============================================="
	@echo ""
	@echo "ä¸»è¦ç›®æ ‡:"
	@echo "  all           - ç¼–è¯‘æ‰€æœ‰æµ‹è¯•"
	@echo "  unit          - ç¼–è¯‘å•å…ƒæµ‹è¯•"
	@echo "  integration   - ç¼–è¯‘é›†æˆæµ‹è¯•"
	@echo "  performance   - ç¼–è¯‘æ€§èƒ½æµ‹è¯•"
	@echo "  errors        - ç¼–è¯‘é”™è¯¯æµ‹è¯•"
	@echo ""
	@echo "è¿è¡Œæµ‹è¯•:"
	@echo "  run-all       - è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  run-unit      - è¿è¡Œå•å…ƒæµ‹è¯•"
	@echo "  run-integration - è¿è¡Œé›†æˆæµ‹è¯•"
	@echo "  run-performance - è¿è¡Œæ€§èƒ½æµ‹è¯•"
	@echo "  run-errors    - è¿è¡Œé”™è¯¯æµ‹è¯•"
	@echo "  run-e2e       - è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•"
	@echo ""
	@echo "å·¥å…·å‘½ä»¤:"
	@echo "  clean         - æ¸…ç†æ„å»ºæ–‡ä»¶"
	@echo "  setup         - è®¾ç½®æµ‹è¯•ç¯å¢ƒ"
	@echo "  install-deps  - æ˜¾ç¤ºä¾èµ–å®‰è£…ä¿¡æ¯"
	@echo "  format        - æ ¼å¼åŒ–ä»£ç "
	@echo "  analyze       - é™æ€ä»£ç åˆ†æ"
	@echo "  memcheck      - å†…å­˜æ³„æ¼æ£€æŸ¥"
	@echo "  coverage      - ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š"
	@echo "  debug         - æ„å»ºè°ƒè¯•ç‰ˆæœ¬"
	@echo "  release       - æ„å»ºå‘å¸ƒç‰ˆæœ¬"
	@echo ""
	@echo "ç¤ºä¾‹:"
	@echo "  make all && make run-all    # ç¼–è¯‘å¹¶è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  make unit && make run-unit  # ç¼–è¯‘å¹¶è¿è¡Œå•å…ƒæµ‹è¯•"
	@echo "  make run-e2e               # è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•" 